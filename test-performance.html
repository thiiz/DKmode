<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dark Theme Extension - Performance Testing</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .subtitle {
      color: #666;
      margin: 0;
    }

    .test-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .test-section h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .metric-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }

    .metric-card.warning {
      border-left-color: #ffc107;
    }

    .metric-card.danger {
      border-left-color: #dc3545;
    }

    .metric-card.success {
      border-left-color: #28a745;
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .metric-subtext {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    .stats-table th,
    .stats-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .stats-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    .stats-table tr:hover {
      background: #f8f9fa;
    }

    .log-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      margin: 15px 0;
    }

    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid transparent;
    }

    .log-entry.info {
      border-left-color: #007bff;
    }

    .log-entry.success {
      border-left-color: #28a745;
    }

    .log-entry.warning {
      border-left-color: #ffc107;
    }

    .log-entry.error {
      border-left-color: #dc3545;
    }

    .timestamp {
      color: #858585;
      margin-right: 10px;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #0056b3);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .content-stress-test {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .test-card {
      background: white;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .test-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .alert {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>üöÄ Dark Theme Extension - Performance Testing</h1>
    <p class="subtitle">Comprehensive performance analysis and optimization testing</p>
  </div>

  <div class="test-section">
    <h2>üìä Real-Time Performance Metrics</h2>
    <div class="button-group">
      <button class="btn-primary" onclick="refreshMetrics()">Refresh Metrics</button>
      <button class="btn-success" onclick="startContinuousMonitoring()">Start Continuous Monitoring</button>
      <button class="btn-danger" onclick="stopContinuousMonitoring()">Stop Monitoring</button>
      <button class="btn-warning" onclick="clearMetrics()">Clear Metrics</button>
    </div>

    <div class="metrics-grid" id="metricsGrid">
      <div class="metric-card">
        <div class="metric-label">Initialization Time</div>
        <div class="metric-value" id="initTime">--</div>
        <div class="metric-subtext">Target: < 50ms</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Apply Theme Avg</div>
          <div class="metric-value" id="applyAvg">--</div>
          <div class="metric-subtext">Target: < 100ms</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Remove Theme Avg</div>
            <div class="metric-value" id="removeAvg">--</div>
            <div class="metric-subtext">Target: < 100ms</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Storage Read Avg</div>
              <div class="metric-value" id="storageReadAvg">--</div>
              <div class="metric-subtext">Target: < 50ms</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Storage Write Avg</div>
                <div class="metric-value" id="storageWriteAvg">--</div>
                <div class="metric-subtext">Target: < 50ms</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Message Handling Avg</div>
                  <div class="metric-value" id="messageAvg">--</div>
                  <div class="metric-subtext">Target: < 50ms</div>
                  </div>
                </div>

                <div id="performanceAlert"></div>

                <h3>Detailed Statistics</h3>
                <table class="stats-table" id="statsTable">
                  <thead>
                    <tr>
                      <th>Operation</th>
                      <th>Count</th>
                      <th>Average</th>
                      <th>Min</th>
                      <th>Max</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="statsTableBody">
                    <tr>
                      <td colspan="6" style="text-align: center; color: #999;">No data available. Click "Refresh
                        Metrics" to load.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="test-section">
                <h2>‚ö° Performance Stress Tests</h2>

                <div class="alert alert-info">
                  <strong>Info:</strong> These tests measure the extension's performance under various conditions.
                </div>

                <h3>Toggle Speed Test</h3>
                <p>Rapidly toggle dark theme on/off to measure responsiveness.</p>
                <div class="button-group">
                  <button class="btn-primary" onclick="runToggleTest(10)">10 Toggles</button>
                  <button class="btn-primary" onclick="runToggleTest(50)">50 Toggles</button>
                  <button class="btn-primary" onclick="runToggleTest(100)">100 Toggles</button>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="toggleProgress" style="width: 0%">0%</div>
                </div>
                <div id="toggleResults"></div>

                <h3>Intensity Adjustment Test</h3>
                <p>Test performance when rapidly changing intensity values.</p>
                <div class="button-group">
                  <button class="btn-primary" onclick="runIntensityTest(20)">20 Changes</button>
                  <button class="btn-primary" onclick="runIntensityTest(50)">50 Changes</button>
                  <button class="btn-primary" onclick="runIntensityTest(100)">100 Changes</button>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="intensityProgress" style="width: 0%">0%</div>
                </div>
                <div id="intensityResults"></div>

                <h3>Memory Usage Test</h3>
                <p>Monitor memory consumption during theme operations.</p>
                <div class="button-group">
                  <button class="btn-primary" onclick="checkMemoryUsage()">Check Memory</button>
                  <button class="btn-success" onclick="runMemoryStressTest()">Run Memory Stress Test</button>
                </div>
                <div id="memoryResults"></div>
              </div>

              <div class="test-section">
                <h2>üé® Visual Performance Test</h2>
                <p>Test theme application on various content types to ensure no visual lag.</p>

                <div class="button-group">
                  <button class="btn-primary" onclick="generateTestContent(50)">Generate 50 Elements</button>
                  <button class="btn-primary" onclick="generateTestContent(200)">Generate 200 Elements</button>
                  <button class="btn-primary" onclick="generateTestContent(500)">Generate 500 Elements</button>
                  <button class="btn-danger" onclick="clearTestContent()">Clear Content</button>
                </div>

                <div class="content-stress-test" id="testContent"></div>
              </div>

              <div class="test-section">
                <h2>üìù Performance Log</h2>
                <div class="button-group">
                  <button class="btn-warning" onclick="clearLog()">Clear Log</button>
                  <button class="btn-primary" onclick="exportLog()">Export Log</button>
                </div>
                <div class="log-output" id="logOutput">
                  <div class="log-entry info">
                    <span class="timestamp">[00:00:00]</span>
                    <span>Performance testing initialized. Ready to run tests.</span>
                  </div>
                </div>
              </div>

              <script>
                let monitoringInterval = null;
                let testStartTime = null;

                // Logging functions
                function log(message, type = 'info') {
                  const logOutput = document.getElementById('logOutput');
                  const timestamp = new Date().toLocaleTimeString();
                  const entry = document.createElement('div');
                  entry.className = `log-entry ${type}`;
                  entry.innerHTML = `<span class="timestamp">[${timestamp}]</span><span>${message}</span>`;
                  logOutput.appendChild(entry);
                  logOutput.scrollTop = logOutput.scrollHeight;
                }

                function clearLog() {
                  document.getElementById('logOutput').innerHTML = '';
                  log('Log cleared', 'info');
                }

                function exportLog() {
                  const logOutput = document.getElementById('logOutput');
                  const logText = logOutput.innerText;
                  const blob = new Blob([logText], { type: 'text/plain' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `performance-log-${Date.now()}.txt`;
                  a.click();
                  URL.revokeObjectURL(url);
                  log('Log exported successfully', 'success');
                }

                // Metrics functions
                async function refreshMetrics() {
                  log('Refreshing performance metrics...', 'info');

                  try {
                    // Get performance stats from content script
                    const stats = window.__darkThemePerformance?.getStats();

                    if (!stats) {
                      log('Performance API not available. Make sure the extension is loaded.', 'warning');
                      return;
                    }

                    // Update metric cards
                    document.getElementById('initTime').textContent = stats.initializationTime || '--';

                    const operations = stats.operations || {};

                    document.getElementById('applyAvg').textContent = operations.applyThemeTime?.average || '--';
                    document.getElementById('removeAvg').textContent = operations.removeThemeTime?.average || '--';
                    document.getElementById('storageReadAvg').textContent = operations.storageReadTime?.average || '--';
                    document.getElementById('storageWriteAvg').textContent = operations.storageWriteTime?.average || '--';
                    document.getElementById('messageAvg').textContent = operations.messageHandlingTime?.average || '--';

                    // Update stats table
                    updateStatsTable(operations);

                    // Check for performance issues
                    checkPerformanceIssues(stats);

                    log('Metrics refreshed successfully', 'success');
                  } catch (error) {
                    log(`Error refreshing metrics: ${error.message}`, 'error');
                  }
                }

                function updateStatsTable(operations) {
                  const tbody = document.getElementById('statsTableBody');
                  tbody.innerHTML = '';

                  if (Object.keys(operations).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No operations recorded yet.</td></tr>';
                    return;
                  }

                  for (const [operation, stats] of Object.entries(operations)) {
                    const row = document.createElement('tr');
                    const avgValue = parseFloat(stats.average);
                    const status = avgValue > 50 ? '‚ö†Ô∏è Slow' : '‚úÖ Good';

                    row.innerHTML = `
          <td>${operation}</td>
          <td>${stats.count}</td>
          <td>${stats.average}</td>
          <td>${stats.min}</td>
          <td>${stats.max}</td>
          <td>${status}</td>
        `;
                    tbody.appendChild(row);
                  }
                }

                function checkPerformanceIssues(stats) {
                  const alertDiv = document.getElementById('performanceAlert');
                  const issues = [];

                  // Check initialization time
                  const initTime = parseFloat(stats.initializationTime);
                  if (initTime > 50) {
                    issues.push(`Initialization time (${initTime.toFixed(2)}ms) exceeds target of 50ms`);
                  }

                  // Check operation averages
                  const operations = stats.operations || {};
                  for (const [operation, data] of Object.entries(operations)) {
                    const avg = parseFloat(data.average);
                    if (avg > 50) {
                      issues.push(`${operation} average (${avg.toFixed(2)}ms) exceeds target of 50ms`);
                    }
                  }

                  if (issues.length > 0) {
                    alertDiv.innerHTML = `
          <div class="alert alert-warning">
            <strong>Performance Issues Detected:</strong>
            <ul style="margin: 10px 0 0 20px;">
              ${issues.map(issue => `<li>${issue}</li>`).join('')}
            </ul>
          </div>
        `;
                  } else {
                    alertDiv.innerHTML = `
          <div class="alert alert-success">
            <strong>‚úÖ All performance metrics within target ranges!</strong>
          </div>
        `;
                  }
                }

                function startContinuousMonitoring() {
                  if (monitoringInterval) {
                    log('Monitoring already running', 'warning');
                    return;
                  }

                  log('Starting continuous monitoring (updates every 2 seconds)...', 'info');
                  monitoringInterval = setInterval(refreshMetrics, 2000);
                  refreshMetrics();
                }

                function stopContinuousMonitoring() {
                  if (!monitoringInterval) {
                    log('Monitoring not running', 'warning');
                    return;
                  }

                  clearInterval(monitoringInterval);
                  monitoringInterval = null;
                  log('Continuous monitoring stopped', 'info');
                }

                function clearMetrics() {
                  if (window.__darkThemePerformance) {
                    const metrics = window.__darkThemePerformance.getRawMetrics();
                    metrics.applyThemeTime = [];
                    metrics.removeThemeTime = [];
                    metrics.storageReadTime = [];
                    metrics.storageWriteTime = [];
                    metrics.messageHandlingTime = [];
                    log('Metrics cleared', 'success');
                    refreshMetrics();
                  }
                }

                // Toggle test
                async function runToggleTest(count) {
                  log(`Starting toggle test with ${count} iterations...`, 'info');
                  const startTime = performance.now();
                  const progressBar = document.getElementById('toggleProgress');
                  const resultsDiv = document.getElementById('toggleResults');

                  try {
                    for (let i = 0; i < count; i++) {
                      // Toggle on
                      document.documentElement.classList.add('dark-theme-active');
                      await new Promise(resolve => setTimeout(resolve, 10));

                      // Toggle off
                      document.documentElement.classList.remove('dark-theme-active');
                      await new Promise(resolve => setTimeout(resolve, 10));

                      // Update progress
                      const progress = ((i + 1) / count) * 100;
                      progressBar.style.width = progress + '%';
                      progressBar.textContent = Math.round(progress) + '%';
                    }

                    const totalTime = performance.now() - startTime;
                    const avgTime = totalTime / (count * 2);

                    resultsDiv.innerHTML = `
          <div class="alert alert-success">
            <strong>Toggle Test Complete!</strong><br>
            Total Time: ${totalTime.toFixed(2)}ms<br>
            Average per toggle: ${avgTime.toFixed(2)}ms<br>
            Toggles per second: ${(1000 / avgTime).toFixed(2)}
          </div>
        `;

                    log(`Toggle test completed: ${count} toggles in ${totalTime.toFixed(2)}ms (avg: ${avgTime.toFixed(2)}ms)`, 'success');
                  } catch (error) {
                    log(`Toggle test failed: ${error.message}`, 'error');
                    resultsDiv.innerHTML = `<div class="alert alert-warning">Test failed: ${error.message}</div>`;
                  }
                }

                // Intensity test
                async function runIntensityTest(count) {
                  log(`Starting intensity test with ${count} changes...`, 'info');
                  const startTime = performance.now();
                  const progressBar = document.getElementById('intensityProgress');
                  const resultsDiv = document.getElementById('intensityResults');

                  try {
                    document.documentElement.classList.add('dark-theme-active');

                    for (let i = 0; i < count; i++) {
                      const intensity = Math.random();
                      document.documentElement.style.setProperty('--dark-theme-intensity', intensity);
                      await new Promise(resolve => setTimeout(resolve, 5));

                      const progress = ((i + 1) / count) * 100;
                      progressBar.style.width = progress + '%';
                      progressBar.textContent = Math.round(progress) + '%';
                    }

                    const totalTime = performance.now() - startTime;
                    const avgTime = totalTime / count;

                    resultsDiv.innerHTML = `
          <div class="alert alert-success">
            <strong>Intensity Test Complete!</strong><br>
            Total Time: ${totalTime.toFixed(2)}ms<br>
            Average per change: ${avgTime.toFixed(2)}ms<br>
            Changes per second: ${(1000 / avgTime).toFixed(2)}
          </div>
        `;

                    log(`Intensity test completed: ${count} changes in ${totalTime.toFixed(2)}ms (avg: ${avgTime.toFixed(2)}ms)`, 'success');
                  } catch (error) {
                    log(`Intensity test failed: ${error.message}`, 'error');
                    resultsDiv.innerHTML = `<div class="alert alert-warning">Test failed: ${error.message}</div>`;
                  }
                }

                // Memory test
                function checkMemoryUsage() {
                  if (performance.memory) {
                    const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
                    const total = (performance.memory.totalJSHeapSize / 1048576).toFixed(2);
                    const limit = (performance.memory.jsHeapSizeLimit / 1048576).toFixed(2);

                    document.getElementById('memoryResults').innerHTML = `
          <div class="alert alert-info">
            <strong>Memory Usage:</strong><br>
            Used: ${used} MB<br>
            Total: ${total} MB<br>
            Limit: ${limit} MB<br>
            Usage: ${((used / limit) * 100).toFixed(2)}%
          </div>
        `;

                    log(`Memory check: ${used}MB used of ${limit}MB limit`, 'info');
                  } else {
                    document.getElementById('memoryResults').innerHTML = `
          <div class="alert alert-warning">
            Memory API not available in this browser.
          </div>
        `;
                    log('Memory API not available', 'warning');
                  }
                }

                async function runMemoryStressTest() {
                  log('Starting memory stress test...', 'info');
                  const iterations = 100;

                  if (!performance.memory) {
                    log('Memory API not available', 'warning');
                    return;
                  }

                  const startMemory = performance.memory.usedJSHeapSize;

                  for (let i = 0; i < iterations; i++) {
                    document.documentElement.classList.add('dark-theme-active');
                    document.documentElement.style.setProperty('--dark-theme-intensity', Math.random());
                    await new Promise(resolve => setTimeout(resolve, 10));
                    document.documentElement.classList.remove('dark-theme-active');
                    await new Promise(resolve => setTimeout(resolve, 10));
                  }

                  const endMemory = performance.memory.usedJSHeapSize;
                  const memoryIncrease = ((endMemory - startMemory) / 1048576).toFixed(2);

                  document.getElementById('memoryResults').innerHTML = `
        <div class="alert alert-success">
          <strong>Memory Stress Test Complete!</strong><br>
          Memory increase: ${memoryIncrease} MB<br>
          ${memoryIncrease < 5 ? '‚úÖ Memory usage is acceptable' : '‚ö†Ô∏è High memory usage detected'}
        </div>
      `;

                  log(`Memory stress test completed: ${memoryIncrease}MB increase`, memoryIncrease < 5 ? 'success' : 'warning');
                }

                // Content generation
                function generateTestContent(count) {
                  log(`Generating ${count} test elements...`, 'info');
                  const container = document.getElementById('testContent');
                  const startTime = performance.now();

                  for (let i = 0; i < count; i++) {
                    const card = document.createElement('div');
                    card.className = 'test-card';
                    card.innerHTML = `
          <img src="https://picsum.photos/200/120?random=${i}" alt="Test image ${i}">
          <h4>Test Card ${i + 1}</h4>
          <p>This is test content for performance testing.</p>
          <button>Action ${i + 1}</button>
        `;
                    container.appendChild(card);
                  }

                  const totalTime = performance.now() - startTime;
                  log(`Generated ${count} elements in ${totalTime.toFixed(2)}ms`, 'success');
                }

                function clearTestContent() {
                  document.getElementById('testContent').innerHTML = '';
                  log('Test content cleared', 'info');
                }

                // Initialize
                log('Performance testing page loaded', 'success');
                log('Click "Refresh Metrics" to view current performance data', 'info');
              </script>
</body>

</html>